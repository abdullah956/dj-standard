{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Certificates</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
    }
    .table thead th {
      vertical-align: middle;
      text-align: center;
    }
    .table tbody td {
      vertical-align: middle;
      text-align: center;
    }
    .card-header h5 {
      margin: 0;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">CERTIFICATES</a>
    <div class="d-flex">
      <a href="{% url 'add_certificate' %}" class="btn btn-light me-2">Add New Certificate</a>
      <a href="" class="btn btn-outline-light">Logout</a>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5>Certificate List</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle mb-0">
          <thead class="table-primary">
            <tr>
              <th>Card No</th>
              <th>Photo</th>
              <th>Name</th>
              <th>Iqama ID</th>
              <th>Certified Level</th>
              <th>Model Level</th>
              <th>Issued On</th>
              <th>Valid Until</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for cert in certificates %}
            <tr>
              <td>{{ cert.card_no }}</td>
              <td><img src="{{ cert.photo.url }}" alt="Photo" style="height: 80px;" /></td>

              <td>{{ cert.name }}</td>
              <td>{{ cert.iqama_id }}</td>
              <td>{{ cert.certified_level }}</td>
              <td>{{ cert.model_level }}</td>
              <td>{{ cert.issued_on }}</td>
              <td>{{ cert.valid_until }}</td>
              <td>  
                <button
  class="btn btn-primary  generate-pdf"
  data-card-no="{{ cert.card_no }}"
  data-name="{{ cert.name }}"
  data-iqama-id="{{ cert.iqama_id }}"
  data-certified-level="{{ cert.certified_level }}"
  data-model-level="{{ cert.model_level }}"
  data-issued-on="{{ cert.issued_on|date:'d-m-Y' }}"
  data-valid-until="{{ cert.valid_until|date:'d-m-Y' }}"
  onclick="triggerCardDownload(this)"
>
<i class="bi bi-download"></i>
</button>

              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center">No certificates found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


<script>
  function triggerCardDownload(button) {
    const name = button.dataset.name;
    const idNumber = button.dataset.idno;
    const tacNumber = button.dataset.tsno;
    const company = button.dataset.company;
    const project = button.dataset.soffice;
    const issuedDate = button.dataset.issue;
    const expiryDate = button.dataset.expiry;
    const details = button.dataset.details;
    const profilePicUrl = button.dataset.photo;
    const qrCodeUrl = button.dataset.qr;

    const frontImage = "{% static 'img/TUV.jpg' %}";
    const backImage = "{% static 'img/back.jpg' %}";
    const downImage = "{% static 'img/down.png' %}";
    const top = "{% static 'img/top.png' %}";

    downloadCardAsPDF(
      tacNumber,
      name,
      company,
      project,
      idNumber,
      issuedDate,
      expiryDate,
      details,
      profilePicUrl,
      qrCodeUrl,
      frontImage,
      backImage,
      downImage,
      top
    );
  }

  function downloadCardAsPDF(
    tacNumber,
    name,
    company,
    project,
    idNumber,
    issuedDate,
    expiryDate,
    details,
    profilePicUrl,
    qrCodeUrl,
    frontImage,
    backImage,
    downImage,
    top
  ) {
    const container = document.createElement("div");
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.alignItems = "center";
    container.style.background = "white";
    container.style.width = "600px";
    container.style.height = "850px";
    container.style.position = "absolute";
    container.style.left = "-9999px";

    // Front
    const frontCard = document.createElement("div");
    frontCard.style.width = "600px";
    frontCard.style.height = "400px";
    frontCard.style.position = "relative";
    frontCard.style.background = `url('${frontImage}') no-repeat center center`;
    frontCard.style.backgroundSize = "contain";
    frontCard.innerHTML = `
      <img src="${top}" style="position: absolute; top: 25px; left: 1px; width: 600px; height: 89px;" />
      <p style="position: absolute; top: 125px; left: 40px; color: red; font-size: 20px;"><strong>ID No: ${tacNumber}</strong></p>
      <p style="position: absolute; top: 160px; left: 40px; font-size: 16px;">DETAILS LISTED ON THE REVERSE SIDE OF THE CARD</p>

      <div style="position: absolute; top: 193px; left: 40px; width: 450px; font-size: 19px;">
        <p style="margin: 0;">Name: <span style="margin-left: 70px;">${name}</span></p>
        <p style="margin: 0;">ID/Iqama No.: ${idNumber}</p>
        <p style="margin: 0;">Issued on: <span style="margin-left: 36px;">${issuedDate}</span></p>
        <p style="margin: 0;">Valid up to: <span style="margin-left: 24px;">${expiryDate}</span></p>
      </div>

      <img src="${profilePicUrl}" style="position: absolute; top: 114px; right: 45px; width: 110px; height: 118px;" />
      <img src="${qrCodeUrl}" style="position: absolute; top: 230px; right: 44px; width: 110px; height: 100px;" />

      <p style="position: absolute; top: 332px; left: 38px; color: white; font-size: 19px;">
        Has successfully completed the assessment and examination
      </p>
    `;

    // Back
    const backCard = document.createElement("div");
    backCard.style.width = "600px";
    backCard.style.height = "400px";
    backCard.style.position = "relative";
    backCard.style.background = `url('${backImage}') no-repeat center center`;
    backCard.style.backgroundSize = "contain";
    backCard.innerHTML = `
      <img src="${downImage}" style="position: absolute; top: 25px; right: 15px; width: 220px;" />
      <p style="position: absolute; top: 40px; left: 40px; color: red; font-size: 20px;"><strong>ID No: ${tacNumber}</strong></p>

      <div style="position: absolute; top: 95px; left: 40px; width: 310px; height: 220px; border: 2px solid black; font-size: 14px;">
        <div style="border-bottom: 2px solid black; padding: 5px;"><span style="font-size:18px;">Details:</span></div>
        <div style="padding: 1px 3px; font-size:18px;">
          <p style="margin: 0; padding-left: 20px; text-indent: -10px; line-height: 20px;">-${details}</p>
        </div>
      </div>

      <p style="position: absolute; top: 332px; left: 30px; color: white; font-size: 19px;">
        This card is issued by and remains the property of FAHSS/TUV
      </p>
    `;

    container.appendChild(frontCard);
    container.appendChild(backCard);
    document.body.appendChild(container);

    html2canvas(container, { scale: 3, useCORS: true }).then((canvas) => {
      const { jsPDF } = window.jspdf;
      let pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
      const imgData = canvas.toDataURL("image/png");
      pdf.addImage(imgData, "PNG", 10, 10, 190, 250);
      pdf.save(`ID_Card_${name}.pdf`);
      document.body.removeChild(container);
    });
  }
</script>



</body>
</html>
